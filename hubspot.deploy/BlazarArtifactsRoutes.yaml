# This config allows builds to upload build results to an s3 bucket (hubspot-blazar-artifacts)
# And have those served so that they can be read in a browser.

type: load_balancer
appRoot: /blazar-artifacts
team: hs-faas-infra

loadBalancers:
- privatehubteam

servers:
  qa:
  - s3.amazonaws.com:443
  prod:
  - s3.amazonaws.com:443

nginx:
  proxyConfig: |

    location ~* ^/blazar-artifacts/(.*) {
      set $url_full "$hs_env/$1";

      proxy_pass_header Server;
      proxy_set_header Host hubspot-blazar-artifacts.s3.amazonaws.com;
      proxy_redirect off;

      set_by_lua $now       "return ngx.cookie_time(ngx.time())";
      set $string_to_sign   "$request_method\n\n\n\nx-amz-date:${now}\n/$s3_hubspot_blazar_artifacts_bucket/$url_full";
      set_hmac_sha1          $aws_signature $s3_hubspot_blazar_artifacts_secret_key $string_to_sign;
      set_encode_base64      $aws_signature $aws_signature;

      rewrite .* /$url_full break;

      proxy_set_header       Authorization "AWS $s3_hubspot_blazar_artifacts_access_key:$aws_signature";
      proxy_set_header       x-amz-date $now;

      proxy_pass             https://blazarartifactsroutes;
    }

